<!DOCTYPE html>
<html>
<head>
    <title>Traffic Accident Prediction</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 600px;
        }
    </style>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let map;

        function initializeMap() {
            // Initialize the map and set its view to the specified coordinates
            map = L.map('map').setView([25.236278675862728, 51.20507504572652], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
            }).addTo(map);
        }

        function getColor(accident_count, max_accident_count) {
            // Normalize the accident count to range between 0 and 1
            let ratio = accident_count / max_accident_count;
            // Calculate the color from yellow to red based on the ratio
            let red = Math.floor(255 * ratio);
            let green = 255-Math.floor(255 * ratio);
            let blue = 0;
            return `rgb(${red}, ${green}, ${blue})`;
        }

        async function predict() {
            let year = document.getElementById("year").value;
            
            let response = await fetch("/predict", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ year: year })
            });
            
            let result = await response.json();
            let output = "<h3>Predicted Accidents</h3>";
            
            // Find the maximum accident count for color scaling
            let max_accident_count = 0;
            for (let dept in result) {
                for (let item of result[dept]) {
                    if (item.accident_count > max_accident_count) {
                        max_accident_count = item.accident_count;
                    }
                }
            }
            
            for (let dept in result) {
                for (let item of result[dept]) {
                    // Add circle to the map with color based on accident count
                    L.circle([item.latitude, item.longitude], {
                        color: getColor(item.accident_count, max_accident_count),
                        fillColor: getColor(item.accident_count, max_accident_count),
                        fillOpacity: 0.8,
                        radius: 2000  // Increased radius for better visibility
                    }).addTo(map)
                        .bindPopup(`<b>${dept}</b><br>Year: ${item.year}<br>Accidents: ${item.accident_count.toFixed(2)}`)
                        .openPopup();
                }
                output += "</ul>";
            }
            
            document.getElementById("result").innerHTML = output;
        }

        window.onload = initializeMap;
    </script>
</head>
<body>
    <h1>Traffic Accident Prediction</h1>
    
    <label for="year">Select Year:</label>
    <input type="number" id="year" min="2024" max="2026" value="2024">
    
    <button onclick="predict()">Predict</button>
    
    <div id="result"></div>
    <div id="map"></div>
</body>
</html>